From 4ebf2230660d7eb617d1e96fdf7edf1c0af02770 Mon Sep 17 00:00:00 2001
From: "Kevin F. Haggerty" <haggertk@lineageos.org>
Date: Sun, 25 Nov 2018 14:31:41 -0700
Subject: [PATCH 1/2] Allow init to write to /proc/cpu/alignment

* AOSP init.rc attempts to write to /proc/cpu/alignment, but
  following 84e181bc, general access to procfs nodes is prohibited.
* Add an appropriate type, genfscon, and allow to permit this
  action.

Change-Id: I31ad8eaa6ebb6dd57d1b9c4395cb22cdd0d7b3d3
(cherry picked from commit 6213f5041a6e9242b2a23c8cc85d0d76cbc1fc45)
---
 prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil | 1 +
 prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil | 1 +
 prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil | 1 +
 prebuilts/api/29.0/private/genfs_contexts              | 1 +
 prebuilts/api/29.0/public/file.te                      | 1 +
 prebuilts/api/29.0/public/init.te                      | 1 +
 private/compat/26.0/26.0.ignore.cil                    | 1 +
 private/compat/27.0/27.0.ignore.cil                    | 1 +
 private/compat/28.0/28.0.ignore.cil                    | 1 +
 private/genfs_contexts                                 | 1 +
 public/file.te                                         | 1 +
 public/init.te                                         | 1 +
 12 files changed, 12 insertions(+)

diff --git a/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil b/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
index 35cd852..5a908cf 100644
--- a/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
+++ b/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
@@ -132,6 +132,7 @@
     perfetto_tmpfs
     perfetto_traces_data_file
     perfprofd_service
+    proc_cpu_alignment
     proc_dt_firmware_android
     property_info
     recovery_socket
diff --git a/prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil b/prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil
index 723af8f..f4bf3ac 100644
--- a/prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil
+++ b/prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil
@@ -119,6 +119,7 @@
     perfetto_tmpfs
     perfetto_traces_data_file
     perfprofd_service
+    proc_cpu_alignment
     proc_dt_firmware_android
     property_info
     recovery_socket
diff --git a/prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil b/prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil
index 4128a34..96d649b 100644
--- a/prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil
+++ b/prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil
@@ -104,6 +104,7 @@
     password_slot_metadata_file
     permissionmgr_service
     postinstall_apex_mnt_dir
+    proc_cpu_alignment
     proc_dt_firmware_android
     recovery_socket
     role_service
diff --git a/prebuilts/api/29.0/private/genfs_contexts b/prebuilts/api/29.0/private/genfs_contexts
index 2d3844a..d9b24d0 100644
--- a/prebuilts/api/29.0/private/genfs_contexts
+++ b/prebuilts/api/29.0/private/genfs_contexts
@@ -23,6 +23,7 @@ genfscon proc /net/tcp u:object_r:proc_net_tcp_udp:s0
 genfscon proc /net/udp u:object_r:proc_net_tcp_udp:s0
 genfscon proc /net/xt_qtaguid/ctrl u:object_r:proc_qtaguid_ctrl:s0
 genfscon proc /net/xt_qtaguid/ u:object_r:proc_qtaguid_stat:s0
+genfscon proc /cpu/alignment u:object_r:proc_cpu_alignment:s0
 genfscon proc /cpuinfo u:object_r:proc_cpuinfo:s0
 genfscon proc /pagetypeinfo u:object_r:proc_pagetypeinfo:s0
 genfscon proc /pressure/cpu u:object_r:proc_pressure_cpu:s0
diff --git a/prebuilts/api/29.0/public/file.te b/prebuilts/api/29.0/public/file.te
index 0703fb3..96c0732 100644
--- a/prebuilts/api/29.0/public/file.te
+++ b/prebuilts/api/29.0/public/file.te
@@ -20,6 +20,7 @@ type proc_abi, fs_type, proc_type;
 type proc_asound, fs_type, proc_type;
 type proc_buddyinfo, fs_type, proc_type;
 type proc_cmdline, fs_type, proc_type;
+type proc_cpu_alignment, fs_type, proc_type;
 type proc_cpuinfo, fs_type, proc_type;
 type proc_dirty, fs_type, proc_type;
 type proc_diskstats, fs_type, proc_type;
diff --git a/prebuilts/api/29.0/public/init.te b/prebuilts/api/29.0/public/init.te
index 889afa9..770c485 100644
--- a/prebuilts/api/29.0/public/init.te
+++ b/prebuilts/api/29.0/public/init.te
@@ -327,6 +327,7 @@ allow init {
 
 allow init {
   proc_abi
+  proc_cpu_alignment
   proc_dirty
   proc_hostname
   proc_hung_task
diff --git a/private/compat/26.0/26.0.ignore.cil b/private/compat/26.0/26.0.ignore.cil
index 35cd852..5a908cf 100644
--- a/private/compat/26.0/26.0.ignore.cil
+++ b/private/compat/26.0/26.0.ignore.cil
@@ -132,6 +132,7 @@
     perfetto_tmpfs
     perfetto_traces_data_file
     perfprofd_service
+    proc_cpu_alignment
     proc_dt_firmware_android
     property_info
     recovery_socket
diff --git a/private/compat/27.0/27.0.ignore.cil b/private/compat/27.0/27.0.ignore.cil
index 723af8f..f4bf3ac 100644
--- a/private/compat/27.0/27.0.ignore.cil
+++ b/private/compat/27.0/27.0.ignore.cil
@@ -119,6 +119,7 @@
     perfetto_tmpfs
     perfetto_traces_data_file
     perfprofd_service
+    proc_cpu_alignment
     proc_dt_firmware_android
     property_info
     recovery_socket
diff --git a/private/compat/28.0/28.0.ignore.cil b/private/compat/28.0/28.0.ignore.cil
index 4128a34..96d649b 100644
--- a/private/compat/28.0/28.0.ignore.cil
+++ b/private/compat/28.0/28.0.ignore.cil
@@ -104,6 +104,7 @@
     password_slot_metadata_file
     permissionmgr_service
     postinstall_apex_mnt_dir
+    proc_cpu_alignment
     proc_dt_firmware_android
     recovery_socket
     role_service
diff --git a/private/genfs_contexts b/private/genfs_contexts
index 2d3844a..d9b24d0 100644
--- a/private/genfs_contexts
+++ b/private/genfs_contexts
@@ -23,6 +23,7 @@ genfscon proc /net/tcp u:object_r:proc_net_tcp_udp:s0
 genfscon proc /net/udp u:object_r:proc_net_tcp_udp:s0
 genfscon proc /net/xt_qtaguid/ctrl u:object_r:proc_qtaguid_ctrl:s0
 genfscon proc /net/xt_qtaguid/ u:object_r:proc_qtaguid_stat:s0
+genfscon proc /cpu/alignment u:object_r:proc_cpu_alignment:s0
 genfscon proc /cpuinfo u:object_r:proc_cpuinfo:s0
 genfscon proc /pagetypeinfo u:object_r:proc_pagetypeinfo:s0
 genfscon proc /pressure/cpu u:object_r:proc_pressure_cpu:s0
diff --git a/public/file.te b/public/file.te
index 0703fb3..96c0732 100644
--- a/public/file.te
+++ b/public/file.te
@@ -20,6 +20,7 @@ type proc_abi, fs_type, proc_type;
 type proc_asound, fs_type, proc_type;
 type proc_buddyinfo, fs_type, proc_type;
 type proc_cmdline, fs_type, proc_type;
+type proc_cpu_alignment, fs_type, proc_type;
 type proc_cpuinfo, fs_type, proc_type;
 type proc_dirty, fs_type, proc_type;
 type proc_diskstats, fs_type, proc_type;
diff --git a/public/init.te b/public/init.te
index 889afa9..770c485 100644
--- a/public/init.te
+++ b/public/init.te
@@ -327,6 +327,7 @@ allow init {
 
 allow init {
   proc_abi
+  proc_cpu_alignment
   proc_dirty
   proc_hostname
   proc_hung_task
-- 
2.7.4

