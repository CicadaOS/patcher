From 550b873b26819be0fb80ddbba8a9bcee825966a2 Mon Sep 17 00:00:00 2001
From: Henrique Silva <jhenrique09.mcz@hotmail.com>
Date: Tue, 31 Jul 2018 14:48:30 -0300
Subject: [PATCH] av: camera: Allow disabling shutter sound for specific
 packages

Some third-party cameras play back their shutter sound.
This produces a double sound. This patch fixes this problem.

camera.shutter_sound.blacklist=com.android.camera - allows
to disable the system shutter sound for a specific camera package.

Change-Id: I0a0dd936c9ebf3d2a56aafb7b93a81f1c626a8dc
Signed-off-by: Henrique Silva <jhenrique09.mcz@hotmail.com>
---
 .../camera/libcameraservice/CameraService.cpp  | 18 ++++++++++++++++++
 .../camera/libcameraservice/CameraService.h    |  3 +++
 2 files changed, 21 insertions(+)

diff --git a/services/camera/libcameraservice/CameraService.cpp b/services/camera/libcameraservice/CameraService.cpp
index 87deba211..d2960410f 100644
--- a/services/camera/libcameraservice/CameraService.cpp
+++ b/services/camera/libcameraservice/CameraService.cpp
@@ -2309,6 +2309,22 @@ void CameraService::loadSoundLocked(sound_kind kind) {
     }
 }
 
+void CameraService::ensureCameraShutterSoundDisabled() {
+    char value[PROPERTY_VALUE_MAX];
+    if (property_get("camera.shutter_sound.blacklist", value, NULL) > 0){
+        std::stringstream disable_shutter_package_list(value);
+        std::string package;
+        while(std::getline(disable_shutter_package_list, package, ',')){
+            if (package.compare(String8(mClientPackageName)) == 0){
+                mSoundPlayer[SOUND_SHUTTER] = NULL;
+                mSoundPlayer[SOUND_RECORDING_START] = NULL;
+                mSoundPlayer[SOUND_RECORDING_STOP] = NULL;
+                return;
+            }
+        }
+    }
+}
+
 void CameraService::decreaseSoundRef() {
     Mutex::Autolock lock(mSoundLock);
     LOG1("CameraService::decreaseSoundRef ref=%d", mSoundRef);
@@ -2328,6 +2344,7 @@ void CameraService::playSound(sound_kind kind) {
     LOG1("playSound(%d)", kind);
     Mutex::Autolock lock(mSoundLock);
     loadSoundLocked(kind);
+    ensureCameraShutterSoundDisabled();
     sp<MediaPlayer> player = mSoundPlayer[kind];
     if (player != 0) {
         player->seekTo(0);
@@ -2357,6 +2374,7 @@ CameraService::Client::Client(const sp<CameraService>& cameraService,
 
     mRemoteCallback = cameraClient;
 
+    cameraService->mClientPackageName = clientPackageName;
     cameraService->increaseSoundRef();
 
     LOG1("Client::Client X (pid %d, id %d)", callingPid, mCameraId);
diff --git a/services/camera/libcameraservice/CameraService.h b/services/camera/libcameraservice/CameraService.h
index 22842a1cc..0ab84ab9c 100644
--- a/services/camera/libcameraservice/CameraService.h
+++ b/services/camera/libcameraservice/CameraService.h
@@ -196,6 +196,9 @@ public:
     void                loadSoundLocked(sound_kind kind);
     void                decreaseSoundRef();
     void                increaseSoundRef();
+    void                ensureCameraShutterSoundDisabled();
+    String16            mClientPackageName;
+
     /**
      * Update the state of a given camera device (open/close/active/idle) with
      * the camera proxy service in the system service
-- 
2.25.1

