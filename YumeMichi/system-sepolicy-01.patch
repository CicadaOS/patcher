From 394fcddf699c1883ca18dd3e7dc046c9f48ac1da Mon Sep 17 00:00:00 2001
From: Ivan Iskandar <iiiiskandar14@gmail.com>
Date: Mon, 31 Jul 2017 14:08:27 +0200
Subject: [PATCH 1/3] Sepolicy rules for FontService

Change-Id: I5177363422ae4f8c85d9866fbb94e362d62bae42
---
 private/property_contexts | 1 +
 private/service_contexts  | 1 +
 private/system_server.te  | 9 +++++++++
 public/property.te        | 1 +
 public/service.te         | 1 +
 5 files changed, 13 insertions(+)

diff --git a/private/property_contexts b/private/property_contexts
index 8eb2f28b..a6440572 100644
--- a/private/property_contexts
+++ b/private/property_contexts
@@ -24,6 +24,7 @@ ro.hw.                  u:object_r:system_prop:s0
 sys.                    u:object_r:system_prop:s0
 sys.cppreopt            u:object_r:cppreopt_prop:s0
 sys.powerctl            u:object_r:powerctl_prop:s0
+sys.refresh_theme       u:object_r:theme_prop:s0
 sys.usb.ffs.            u:object_r:ffs_prop:s0
 service.                u:object_r:system_prop:s0
 dhcp.                   u:object_r:dhcp_prop:s0
diff --git a/private/service_contexts b/private/service_contexts
index a82243ff..bf6af7be 100644
--- a/private/service_contexts
+++ b/private/service_contexts
@@ -50,6 +50,7 @@ econtroller                               u:object_r:radio_service:s0
 ethernet                                  u:object_r:ethernet_service:s0
 fingerprint                               u:object_r:fingerprint_service:s0
 font                                      u:object_r:font_service:s0
+dufont                                    u:object_r:dufont_service:s0
 android.hardware.fingerprint.IFingerprintDaemon u:object_r:fingerprintd_service:s0
 gfxinfo                                   u:object_r:gfxinfo_service:s0
 graphicsstats                             u:object_r:graphicsstats_service:s0
diff --git a/private/system_server.te b/private/system_server.te
index 40c5382d..37860df9 100644
--- a/private/system_server.te
+++ b/private/system_server.te
@@ -483,6 +483,10 @@ set_prop(system_server, cppreopt_prop)
 # Collect metrics on boot time created by init
 get_prop(system_server, boottime_prop)
 
+# theme property
+get_prop(system_server, theme_prop)
+set_prop(system_server, theme_prop)
+
 # Read device's serial number from system properties
 get_prop(system_server, serialno_prop)
 
@@ -556,6 +560,7 @@ allow system_server audioserver_service:service_manager find;
 allow system_server batteryproperties_service:service_manager find;
 allow system_server cameraserver_service:service_manager find;
 allow system_server drmserver_service:service_manager find;
+allow system_server dufont_service:service_manager find;
 allow system_server dumpstate_service:service_manager find;
 allow system_server fingerprintd_service:service_manager find;
 allow system_server hal_fingerprint_service:service_manager find;
@@ -653,6 +658,10 @@ allow system_server adbd:unix_stream_socket { getattr getopt ioctl read write sh
 # Allow invoking tools like "timeout"
 allow system_server toolbox_exec:file rx_file_perms;
 
+# Allow access theme data files
+allow system_server theme_data_file:dir { create_dir_perms relabelto rw_dir_perms };
+allow system_server theme_data_file:file { create_file_perms relabelto rw_file_perms };
+
 # Postinstall
 #
 # For OTA dexopt, allow calls coming from postinstall.
diff --git a/public/property.te b/public/property.te
index 95efcaa7..8b8e9a2c 100644
--- a/public/property.te
+++ b/public/property.te
@@ -44,6 +44,7 @@ type serialno_prop, property_type;
 type shell_prop, property_type, core_property_type;
 type system_prop, property_type, core_property_type;
 type system_radio_prop, property_type, core_property_type;
+type theme_prop, property_type;
 type vold_prop, property_type, core_property_type;
 type wifi_log_prop, property_type, log_property_type;
 type wifi_prop, property_type;
diff --git a/public/service.te b/public/service.te
index e97b864d..94e7fe4b 100644
--- a/public/service.te
+++ b/public/service.te
@@ -66,6 +66,7 @@ type device_identifiers_service, app_api_service, ephemeral_app_api_service, sys
 type devicestoragemonitor_service, system_server_service, service_manager_type;
 type diskstats_service, system_api_service, system_server_service, service_manager_type;
 type display_service, app_api_service, ephemeral_app_api_service, system_server_service, service_manager_type;
+type dufont_service, app_api_service, system_server_service, service_manager_type;
 type font_service, app_api_service, ephemeral_app_api_service, system_server_service, service_manager_type;
 type netd_listener_service, system_server_service, service_manager_type;
 type DockObserver_service, system_server_service, service_manager_type;
-- 
2.17.0

