From ef68d209731c18d2dc1cbe9a759caf3a01ddb420 Mon Sep 17 00:00:00 2001
From: YumeMichi <do4suki@gmail.com>
Date: Fri, 28 Sep 2018 16:01:08 +0800
Subject: [PATCH] configpanel: Notification slider updates

Change-Id: Ieccd6c0a4bcdbcadeb3ca2390dbed094f7ae2238
Signed-off-by: YumeMichi <do4suki@gmail.com>
---
 configpanel/res/values-zh-rCN/strings.xml           |  5 ++---
 configpanel/res/values/arrays.xml                   |  6 ++----
 configpanel/res/values/strings.xml                  |  5 ++---
 .../org/lineageos/settings/device/KeyHandler.java   | 21 +++++++++++++--------
 4 files changed, 19 insertions(+), 18 deletions(-)

diff --git a/configpanel/res/values-zh-rCN/strings.xml b/configpanel/res/values-zh-rCN/strings.xml
index 9af5a41..a9bb4ad 100644
--- a/configpanel/res/values-zh-rCN/strings.xml
+++ b/configpanel/res/values-zh-rCN/strings.xml
@@ -44,8 +44,7 @@
   <string name="notification_slider_top_position">顶部位置</string>
   <string name="notification_slider_middle_position">中间位置</string>
   <string name="notification_slider_bottom_position">底部位置</string>
-  <string name="notification_slider_mode_total_silence">总是静音</string>
-  <string name="notification_slider_mode_alarms_only">仅限闹铃</string>
-  <string name="notification_slider_mode_priority_only">仅限优先</string>
+  <string name="notification_slider_mode_zen">请勿打扰</string>
+  <string name="notification_slider_mode_vibrate">振动</string>
   <string name="notification_slider_mode_none">无</string>
 </resources>
diff --git a/configpanel/res/values/arrays.xml b/configpanel/res/values/arrays.xml
index 67368cd..1c3df8b 100644
--- a/configpanel/res/values/arrays.xml
+++ b/configpanel/res/values/arrays.xml
@@ -17,14 +17,12 @@
 <resources>
 
     <string-array name="notification_slider_action_entries" translatable="false">
-        <item>@string/notification_slider_mode_total_silence</item>
-        <item>@string/notification_slider_mode_alarms_only</item>
-        <item>@string/notification_slider_mode_priority_only</item>
+        <item>@string/notification_slider_mode_zen</item>
+        <item>@string/notification_slider_mode_vibrate</item>
         <item>@string/notification_slider_mode_none</item>
     </string-array>
 
     <string-array name="notification_slider_action_entry_values" translatable="false">
-        <item>600</item>
         <item>601</item>
         <item>602</item>
         <item>603</item>
diff --git a/configpanel/res/values/strings.xml b/configpanel/res/values/strings.xml
index b338e4f..03d3d67 100644
--- a/configpanel/res/values/strings.xml
+++ b/configpanel/res/values/strings.xml
@@ -49,8 +49,7 @@
     <string name="notification_slider_top_position">Top position</string>
     <string name="notification_slider_middle_position">Middle position</string>
     <string name="notification_slider_bottom_position">Bottom position</string>
-    <string name="notification_slider_mode_total_silence">Total silence</string>
-    <string name="notification_slider_mode_alarms_only">Alarms only</string>
-    <string name="notification_slider_mode_priority_only">Priority only</string>
+    <string name="notification_slider_mode_zen">Do not disturb</string>
+    <string name="notification_slider_mode_vibrate">Vibrate</string>
     <string name="notification_slider_mode_none">None</string>
 </resources>
diff --git a/configpanel/src/org/lineageos/settings/device/KeyHandler.java b/configpanel/src/org/lineageos/settings/device/KeyHandler.java
index be1e559..a311603 100644
--- a/configpanel/src/org/lineageos/settings/device/KeyHandler.java
+++ b/configpanel/src/org/lineageos/settings/device/KeyHandler.java
@@ -26,6 +26,7 @@ import android.hardware.Sensor;
 import android.hardware.SensorEvent;
 import android.hardware.SensorEventListener;
 import android.hardware.SensorManager;
+import android.media.AudioManager;
 import android.media.session.MediaSessionLegacyHelper;
 import android.os.Handler;
 import android.os.Message;
@@ -50,25 +51,23 @@ public class KeyHandler implements DeviceKeyHandler {
 
     // Supported scancodes
     private static final int FLIP_CAMERA_SCANCODE = 249;
-    private static final int MODE_TOTAL_SILENCE = 600;
-    private static final int MODE_ALARMS_ONLY = 601;
-    private static final int MODE_PRIORITY_ONLY = 602;
+    private static final int MODE_ZEN = 601;
+    private static final int MODE_VIBRATE = 602;
     private static final int MODE_NONE = 603;
 
     private static final int GESTURE_WAKELOCK_DURATION = 3000;
 
     private static final SparseIntArray sSupportedSliderModes = new SparseIntArray();
     static {
-        sSupportedSliderModes.put(MODE_TOTAL_SILENCE, Settings.Global.ZEN_MODE_NO_INTERRUPTIONS);
-        sSupportedSliderModes.put(MODE_ALARMS_ONLY, Settings.Global.ZEN_MODE_ALARMS);
-        sSupportedSliderModes.put(MODE_PRIORITY_ONLY,
-                Settings.Global.ZEN_MODE_IMPORTANT_INTERRUPTIONS);
+        sSupportedSliderModes.put(MODE_ZEN, Settings.Global.ZEN_MODE_NO_INTERRUPTIONS);
+        sSupportedSliderModes.put(MODE_VIBRATE, Settings.Global.ZEN_MODE_OFF);
         sSupportedSliderModes.put(MODE_NONE, Settings.Global.ZEN_MODE_OFF);
     }
 
     private final Context mContext;
     private final PowerManager mPowerManager;
     private final NotificationManager mNotificationManager;
+    private final AudioManager mAudioManager;
     private EventHandler mEventHandler;
     private SensorManager mSensorManager;
     private Sensor mProximitySensor;
@@ -83,6 +82,7 @@ public class KeyHandler implements DeviceKeyHandler {
         mPowerManager = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
         mNotificationManager
                 = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
+        mAudioManager = (AudioManager) context.getSystemService(Context.AUDIO_SERVICE);
         mEventHandler = new EventHandler();
         mGestureWakeLock = mPowerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,
                 "GestureWakeLock");
@@ -148,7 +148,12 @@ public class KeyHandler implements DeviceKeyHandler {
 
         if (isSliderModeSupported) {
             mNotificationManager.setZenMode(sSupportedSliderModes.get(scanCode), null, TAG);
-            doHapticFeedback();
+            if (scanCode == MODE_NONE) {
+                mAudioManager.setRingerModeInternal(AudioManager.RINGER_MODE_NORMAL);
+                doHapticFeedback();
+            } else if (scanCode == MODE_VIBRATE) {
+                mAudioManager.setRingerModeInternal(AudioManager.RINGER_MODE_VIBRATE);
+            }
         } else if (!mEventHandler.hasMessages(GESTURE_REQUEST)) {
             Message msg = getMessageForKeyEvent(scanCode);
             boolean defaultProximity = mContext.getResources().getBoolean(
-- 
2.7.4

