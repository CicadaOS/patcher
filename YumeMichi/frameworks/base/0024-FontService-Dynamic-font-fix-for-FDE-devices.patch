From 63081b6f432aa666091d22c96347135c14e2021f Mon Sep 17 00:00:00 2001
From: maxwen <max.weninger@gmail.com>
Date: Fri, 6 Apr 2018 00:27:20 +0200
Subject: [PATCH 24/35] FontService: Dynamic font fix for FDE devices

Change-Id: I337af1c07b98bbda2b85020229b2905f9ec7f7ff
---
 .../core/java/com/android/server/FontService.java   | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/services/core/java/com/android/server/FontService.java b/services/core/java/com/android/server/FontService.java
index 71e0ea0b8e0..0b4e44e792d 100644
--- a/services/core/java/com/android/server/FontService.java
+++ b/services/core/java/com/android/server/FontService.java
@@ -104,11 +104,16 @@ public class FontService extends IFontService.Stub {
         @Override
         public void onBootPhase(int phase) {
             if (phase == PHASE_SYSTEM_SERVICES_READY) {
-                if (makeDir(SYSTEM_THEME_DIR)) {
-                    makeDir(SYSTEM_THEME_PREVIEW_CACHE_DIR);
-                    restoreconThemeDir();
+                String cryptState = SystemProperties.get("vold.decrypt");
+                // wait until decrypted if we use FDE or just go one if not (cryptState will be empty then)
+                if (TextUtils.isEmpty(cryptState) || cryptState.equals("trigger_restart_framework")) {
+                    Log.d(TAG, "onBootPhase " + phase + " " + cryptState);
+                    if (makeDir(SYSTEM_THEME_DIR)) {
+                        makeDir(SYSTEM_THEME_PREVIEW_CACHE_DIR);
+                        restoreconThemeDir();
+                    }
+                    mService.sendInitializeFontMapMessage();
                 }
-                mService.sendInitializeFontMapMessage();
             }
         }
     }
-- 
2.20.0

