From 2f1d69afde0cafbd359acf9b2837d41c9ed18814 Mon Sep 17 00:00:00 2001
From: ghbhaha <ghbhaha@gmail.com>
Date: Thu, 6 Oct 2016 21:33:28 +0800
Subject: [PATCH 1/2] CMParts: Status Bar Carriers [2/2]

Change-Id: Ibc7877173932c99785f87c04ccbc812e96268768
---
 res/values-zh-rCN/sm_strings.xml                   |  10 ++
 res/values/sm_arrays.xml                           |  12 +++
 res/values/sm_strings.xml                          |  10 ++
 res/xml/status_bar_settings.xml                    |  22 ++++
 .../cmparts/statusbar/StatusBarSettings.java       | 120 +++++++++++++++++++++
 5 files changed, 174 insertions(+)

diff --git a/res/values-zh-rCN/sm_strings.xml b/res/values-zh-rCN/sm_strings.xml
index 945b40c..5793090 100644
--- a/res/values-zh-rCN/sm_strings.xml
+++ b/res/values-zh-rCN/sm_strings.xml
@@ -26,4 +26,14 @@
   <string name="recents_clear_all_location_bottom_right">右下方</string>
   <string name="recents_clear_all_location_bottom_left">左下方</string>
   <string name="recents_clear_all_location_bottom_center">下方中央</string>
+    <!-- Show carrier label and custom -->
+    <string name="show_status_bar_carrier_title">运营商名称</string>
+    <string name="show_status_bar_carrier_summary">在状态栏显示运营商名称</string>
+    <string name="custom_carrier_label_title">自定义运营商名称</string>
+    <string name="custom_carrier_label_explain">请输入新的运营商名称，留空为恢复默认运营商名称。</string>
+    <string name="custom_carrier_label_notset">当前没有设置运营商名称</string>
+    <string name="show_carrier_speed_title">运营商字体大小</string>
+    <string name="carrier_size_style_normal">正常</string>
+    <string name="carrier_size_style_small">小</string>
+    <string name="carrier_size_style_big">大</string>
 </resources>
diff --git a/res/values/sm_arrays.xml b/res/values/sm_arrays.xml
index a921e6a..170564d 100644
--- a/res/values/sm_arrays.xml
+++ b/res/values/sm_arrays.xml
@@ -16,6 +16,18 @@
 -->
 
 <resources xmlns:xliff="urn:oasis:names:tc:xliff:document:1.2">
+    <!-- carrier size -->
+    <string-array name="entries_carrier_size_style" translatable="false">
+        <item>@string/carrier_size_style_normal</item>
+        <item>@string/carrier_size_style_small</item>
+        <item>@string/carrier_size_style_big</item>
+    </string-array>
+
+    <string-array name="values_carrier_size_style" translatable="false">
+        <item>5</item>
+        <item>4</item>
+        <item>6</item>
+    </string-array>
 
     <!-- clear all recents button location -->
     <string-array name="recents_clear_all_location_entries">
diff --git a/res/values/sm_strings.xml b/res/values/sm_strings.xml
index 03095f4..75720fa 100644
--- a/res/values/sm_strings.xml
+++ b/res/values/sm_strings.xml
@@ -28,5 +28,15 @@
     <string name="recents_clear_all_location_bottom_right">Bottom right</string>
     <string name="recents_clear_all_location_bottom_left">Bottom left</string>
     <string name="recents_clear_all_location_bottom_center">Bottom center</string>
+    <!-- Show carrier label and custom -->
+    <string name="show_status_bar_carrier_title">Status bar carrier</string>
+    <string name="show_status_bar_carrier_summary">Show carrier in status bar</string>
+    <string name="custom_carrier_label_title">Custom carrier label</string>
+    <string name="custom_carrier_label_explain">Please enter a new label. Leave blank to revert to stock label.</string>
+    <string name="custom_carrier_label_notset">Custom label currently not set</string>
+    <string name="show_carrier_speed_title">Operators of font size</string>
+    <string name="carrier_size_style_normal">Normal</string>
+    <string name="carrier_size_style_small">Small</string>
+    <string name="carrier_size_style_big">Big</string>
 
 </resources>
diff --git a/res/xml/status_bar_settings.xml b/res/xml/status_bar_settings.xml
index 0c902a2..c2a5053 100644
--- a/res/xml/status_bar_settings.xml
+++ b/res/xml/status_bar_settings.xml
@@ -27,6 +27,28 @@
         android:entryValues="@array/status_bar_quick_qs_pulldown_values"
         android:defaultValue="0" />
 
+
+    <PreferenceCategory android:key="show_status_carrier_options"
+        android:title="@string/show_status_bar_carrier_title">
+
+        <SwitchPreference android:defaultValue="false"
+            android:key="status_bar_carrier"
+            android:summary="@string/show_status_bar_carrier_summary"
+            android:title="@string/show_status_bar_carrier_title" />
+
+        <PreferenceScreen android:dependency="status_bar_carrier"
+            android:key="custom_carrier_label"
+            android:title="@string/custom_carrier_label_title" />
+
+        <ListPreference android:defaultValue="5"
+            android:dependency="status_bar_carrier"
+            android:dialogTitle="@string/show_carrier_speed_title"
+            android:entries="@array/entries_carrier_size_style"
+            android:entryValues="@array/values_carrier_size_style"
+            android:key="carrier_size_style" android:title="@string/show_carrier_speed_title" />
+
+    </PreferenceCategory>
+
     <PreferenceCategory
         android:title="@string/status_bar_icons_title">
 
diff --git a/src/org/cyanogenmod/cmparts/statusbar/StatusBarSettings.java b/src/org/cyanogenmod/cmparts/statusbar/StatusBarSettings.java
index 2d468c7..1a65dbc 100644
--- a/src/org/cyanogenmod/cmparts/statusbar/StatusBarSettings.java
+++ b/src/org/cyanogenmod/cmparts/statusbar/StatusBarSettings.java
@@ -16,9 +16,15 @@
  */
 package org.cyanogenmod.cmparts.statusbar;
 
+import android.app.AlertDialog;
 import android.os.Bundle;
+import android.provider.Settings;
+import android.support.v14.preference.SwitchPreference;
+import android.support.v7.preference.ListPreference;
 import android.support.v7.preference.Preference;
+import android.support.v7.preference.PreferenceScreen;
 import android.support.v7.preference.Preference.OnPreferenceChangeListener;
+import android.text.TextUtils;
 import android.text.format.DateFormat;
 import android.view.View;
 
@@ -27,6 +33,15 @@ import cyanogenmod.preference.CMSystemSettingListPreference;
 import org.cyanogenmod.cmparts.R;
 import org.cyanogenmod.cmparts.SettingsPreferenceFragment;
 
+import android.text.format.DateFormat;
+import android.widget.EditText;
+import android.widget.LinearLayout;
+import android.text.Spannable;
+import android.content.Intent;
+import android.content.ContentResolver;
+import android.content.DialogInterface;
+import android.telephony.TelephonyManager;
+
 public class StatusBarSettings extends SettingsPreferenceFragment
         implements OnPreferenceChangeListener {
 
@@ -36,6 +51,10 @@ public class StatusBarSettings extends SettingsPreferenceFragment
     private static final String STATUS_BAR_SHOW_BATTERY_PERCENT = "status_bar_show_battery_percent";
     private static final String STATUS_BAR_QUICK_QS_PULLDOWN = "qs_quick_pulldown";
 
+    private static final String STATUS_BAR_CARRIER = "status_bar_carrier";
+    private static final String CUSTOM_CARRIER_LABEL = "custom_carrier_label";
+    private static final String CARRIER_SIZE_STYLE = "carrier_size_style";
+
     private static final int STATUS_BAR_BATTERY_STYLE_HIDDEN = 4;
     private static final int STATUS_BAR_BATTERY_STYLE_TEXT = 6;
     private static final int PULLDOWN_DIR_NONE = 0;
@@ -48,6 +67,11 @@ public class StatusBarSettings extends SettingsPreferenceFragment
     private CMSystemSettingListPreference mStatusBarBattery;
     private CMSystemSettingListPreference mStatusBarBatteryShowPercent;
 
+    private SwitchPreference mStatusBarCarrier;
+    private PreferenceScreen mCustomCarrierLabel;
+    private ListPreference mCarrierSize;
+    private String mCustomCarrierLabelText;
+
     @Override
     public void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
@@ -72,6 +96,28 @@ public class StatusBarSettings extends SettingsPreferenceFragment
                 (CMSystemSettingListPreference) findPreference(STATUS_BAR_QUICK_QS_PULLDOWN);
         mQuickPulldown.setOnPreferenceChangeListener(this);
         updateQuickPulldownSummary(mQuickPulldown.getIntValue(0));
+
+        mCarrierSize = (ListPreference) findPreference(CARRIER_SIZE_STYLE);
+        int CarrierSize = Settings.System.getInt(resolver,
+                Settings.System.CARRIER_SIZE, 5);
+        mCarrierSize.setValue(String.valueOf(CarrierSize));
+        mCarrierSize.setSummary(mCarrierSize.getEntry());
+        mCarrierSize.setOnPreferenceChangeListener(this);
+
+        PreferenceScreen prefSet = getPreferenceScreen();
+        mStatusBarCarrier = (SwitchPreference) prefSet
+                .findPreference(STATUS_BAR_CARRIER);
+        mStatusBarCarrier.setChecked((Settings.System.getInt(resolver,
+                Settings.System.STATUS_BAR_CARRIER, 0) == 1));
+        mStatusBarCarrier.setOnPreferenceChangeListener(this);
+        mCustomCarrierLabel = (PreferenceScreen) prefSet
+                .findPreference(CUSTOM_CARRIER_LABEL);
+        if (TelephonyManager.getDefault().isMultiSimEnabled()) {
+            prefSet.removePreference(mStatusBarCarrier);
+            prefSet.removePreference(mCustomCarrierLabel);
+        } else {
+            updateCustomLabelTextSummary();
+        }
     }
 
     @Override
@@ -92,10 +138,84 @@ public class StatusBarSettings extends SettingsPreferenceFragment
             updateQuickPulldownSummary(value);
         } else if (preference == mStatusBarBattery) {
             enableStatusBarBatteryDependents(value);
+        } else if (preference == mStatusBarCarrier) {
+            boolean value = (Boolean) objValue;
+            Settings.System.putInt(getContentResolver(),
+                    Settings.System.STATUS_BAR_CARRIER, value ? 1 : 0);
+            Intent i = new Intent();
+            i.setAction(Intent.ACTION_CUSTOM_CARRIER_LABEL_CHANGED);
+            getActivity().sendBroadcast(i);
+        } else if (preference == mCarrierSize) {
+            String newValue = (String) objValue;
+            int CarrierSize = Integer.valueOf((String) newValue);
+            int index = mCarrierSize.findIndexOfValue((String) newValue);
+            Settings.System.putInt(getContentResolver(), Settings.System.CARRIER_SIZE,
+                    CarrierSize);
+            mCarrierSize.setSummary(mCarrierSize.getEntries()[index]);
+            Intent i = new Intent();
+            i.setAction(Intent.ACTION_CUSTOM_CARRIER_LABEL_CHANGED);
+            getActivity().sendBroadcast(i);
+
         }
         return true;
     }
 
+    @Override
+    public boolean onPreferenceTreeClick(Preference preference) {
+        final ContentResolver resolver = getActivity().getContentResolver();
+        if (preference.getKey().equals(CUSTOM_CARRIER_LABEL)) {
+            AlertDialog.Builder alert = new AlertDialog.Builder(getActivity());
+            alert.setTitle(R.string.custom_carrier_label_title);
+            alert.setMessage(R.string.custom_carrier_label_explain);
+            LinearLayout parent = new LinearLayout(getActivity());
+            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(
+                    LinearLayout.LayoutParams.MATCH_PARENT,
+                    LinearLayout.LayoutParams.MATCH_PARENT);
+            parent.setLayoutParams(params);
+            // Set an EditText view to get user input
+            final EditText input = new EditText(getActivity());
+            input.setText(TextUtils.isEmpty(mCustomCarrierLabelText) ? ""
+                    : mCustomCarrierLabelText);
+            input.setSelection(input.getText().length());
+            params.setMargins(60, 0, 60, 0);
+            input.setLayoutParams(params);
+            parent.addView(input);
+            alert.setView(parent);
+            alert.setPositiveButton(getString(android.R.string.ok),
+                    new DialogInterface.OnClickListener() {
+                        public void onClick(DialogInterface dialog,
+                                            int whichButton) {
+                            String value = ((Spannable) input.getText())
+                                    .toString().trim();
+                            Settings.System
+                                    .putString(
+                                            resolver,
+                                            Settings.System.CUSTOM_CARRIER_LABEL,
+                                            value);
+                            updateCustomLabelTextSummary();
+                            Intent i = new Intent();
+                            i.setAction(Intent.ACTION_CUSTOM_CARRIER_LABEL_CHANGED);
+                            getActivity().sendBroadcast(i);
+                        }
+                    });
+            alert.setNegativeButton(getString(android.R.string.cancel), null);
+            alert.show();
+        }
+        return super.onPreferenceTreeClick(preference);
+    }
+
+    private void updateCustomLabelTextSummary() {
+        mCustomCarrierLabelText = Settings.System.getString(getActivity()
+                .getContentResolver(), Settings.System.CUSTOM_CARRIER_LABEL);
+
+        if (TextUtils.isEmpty(mCustomCarrierLabelText)) {
+            mCustomCarrierLabel
+                    .setSummary(R.string.custom_carrier_label_notset);
+        } else {
+            mCustomCarrierLabel.setSummary(mCustomCarrierLabelText);
+        }
+    }
+
     private void enableStatusBarBatteryDependents(int batteryIconStyle) {
         mStatusBarBatteryShowPercent.setEnabled(
                 batteryIconStyle != STATUS_BAR_BATTERY_STYLE_HIDDEN
-- 
2.13.2

